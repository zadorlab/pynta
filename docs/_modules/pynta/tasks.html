

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pynta.tasks &mdash; Pynta January 25, 2023 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Pynta
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pynta</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pynta.tasks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pynta.tasks</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span> <span class="nn">ase.optimize</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ase.constraints</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ase.io</span> <span class="kn">import</span> <span class="n">write</span><span class="p">,</span> <span class="n">read</span>
<span class="kn">from</span> <span class="nn">ase.io.trajectory</span> <span class="kn">import</span> <span class="n">Trajectory</span>
<span class="kn">from</span> <span class="nn">ase.calculators.socketio</span> <span class="kn">import</span> <span class="n">SocketIOCalculator</span>
<span class="kn">from</span> <span class="nn">ase.vibrations</span> <span class="kn">import</span> <span class="n">Vibrations</span>
<span class="kn">from</span> <span class="nn">acat.adsorption_sites</span> <span class="kn">import</span> <span class="n">SlabAdsorptionSites</span>
<span class="kn">from</span> <span class="nn">acat.adsorbate_coverage</span> <span class="kn">import</span> <span class="n">SlabAdsorbateCoverage</span>
<span class="kn">from</span> <span class="nn">molecule.molecule</span> <span class="kn">import</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">sella</span> <span class="kn">import</span> <span class="n">Sella</span><span class="p">,</span> <span class="n">Constraints</span><span class="p">,</span> <span class="n">IRC</span>
<span class="kn">from</span> <span class="nn">fireworks</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fireworks.core.rocket_launcher</span> <span class="kn">import</span> <span class="n">rapidfire</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_utilities</span> <span class="kn">import</span> <span class="n">explicit_serialize</span>
<span class="kn">from</span> <span class="nn">fireworks.queue.queue_launcher</span> <span class="kn">import</span> <span class="n">rapidfire</span> <span class="k">as</span> <span class="n">rapidfirequeue</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_serializers</span> <span class="kn">import</span> <span class="n">load_object_from_file</span>
<span class="kn">from</span> <span class="nn">fireworks.core.fworker</span> <span class="kn">import</span> <span class="n">FWorker</span>
<span class="kn">import</span> <span class="nn">fireworks.fw_config</span>
<span class="kn">from</span> <span class="nn">pynta.transitionstate</span> <span class="kn">import</span> <span class="n">get_unique_optimized_adsorbates</span><span class="p">,</span><span class="n">determine_TS_construction</span><span class="p">,</span><span class="n">get_unique_TS_structs</span><span class="p">,</span><span class="n">generate_constraints_harmonic_parameters</span><span class="p">,</span><span class="n">get_surface_forming_bond_pairings</span>
<span class="kn">from</span> <span class="nn">pynta.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pynta.calculator</span> <span class="kn">import</span> <span class="n">run_harmonically_forced_xtb</span><span class="p">,</span> <span class="n">add_sella_constraint</span>
<span class="kn">from</span> <span class="nn">pynta.mol</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">xtb.ase.calculator</span> <span class="kn">import</span> <span class="n">XTB</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<div class="viewcode-block" id="OptimizationTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.OptimizationTask">[docs]</a><span class="k">class</span> <span class="nc">OptimizationTask</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
<div class="viewcode-block" id="OptimizationTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.OptimizationTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="EnergyTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.EnergyTask">[docs]</a><span class="k">class</span> <span class="nc">EnergyTask</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
<div class="viewcode-block" id="EnergyTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.EnergyTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="VibrationTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.VibrationTask">[docs]</a><span class="k">class</span> <span class="nc">VibrationTask</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
<div class="viewcode-block" id="VibrationTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.VibrationTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="CollectTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.CollectTask">[docs]</a><span class="k">class</span> <span class="nc">CollectTask</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
<div class="viewcode-block" id="CollectTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.CollectTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="DoNothingTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.DoNothingTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">DoNothingTask</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
<div class="viewcode-block" id="DoNothingTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.DoNothingTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="optimize_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.optimize_firework">[docs]</a><span class="k">def</span> <span class="nf">optimize_firework</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">software</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">opt_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sella</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">socket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="p">{},</span>
                      <span class="n">run_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">constraints</span><span class="o">=</span><span class="p">[],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">time_limit_hrs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">fmaxhard</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">target_site_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">metal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">facet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xyz&quot;</span> <span class="p">:</span> <span class="n">xyz</span><span class="p">,</span> <span class="s2">&quot;software&quot;</span> <span class="p">:</span> <span class="n">software</span><span class="p">,</span><span class="s2">&quot;label&quot;</span> <span class="p">:</span> <span class="n">label</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">opt_method</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;opt_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_method</span>
    <span class="k">if</span> <span class="n">software_kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">software_kwargs</span>
    <span class="k">if</span> <span class="n">opt_kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;opt_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_kwargs</span>
    <span class="k">if</span> <span class="n">run_kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_kwargs</span>
    <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints</span>
    <span class="n">sella</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">sella</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sella</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sella</span><span class="p">:</span> <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1">#without Sella only minization is possible</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sella&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sella</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;socket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;time_limit_hrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_limit_hrs</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fmaxhard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmaxhard</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_errors</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;target_site_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_site_num</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;metal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metal</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;facet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facet</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">MolecularOptimizationTask</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.xyz&quot;</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">FileTransferTask</span><span class="p">({</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">+</span><span class="s1">&#39;.xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">out_path</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">+</span><span class="s1">&#39;.traj&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">)}],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_errors&#39;</span> <span class="p">:</span> <span class="n">ignore_errors</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">Firework</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;opt&quot;</span><span class="p">,</span><span class="n">spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">})</span></div>

<div class="viewcode-block" id="MolecularOptimizationTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularOptimizationTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularOptimizationTask</span><span class="p">(</span><span class="n">OptimizationTask</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;opt_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;opt_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;constraints&quot;</span><span class="p">,</span><span class="s2">&quot;sella&quot;</span><span class="p">,</span><span class="s2">&quot;order&quot;</span><span class="p">,</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span><span class="s2">&quot;time_limit_hrs&quot;</span><span class="p">,</span><span class="s2">&quot;fmaxhard&quot;</span><span class="p">,</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">,</span><span class="s2">&quot;target_site_num&quot;</span><span class="p">,</span><span class="s2">&quot;metal&quot;</span><span class="p">,</span><span class="s2">&quot;facet&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularOptimizationTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularOptimizationTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">software_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;software_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;socket&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;socket&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">socket</span><span class="p">:</span>
            <span class="n">unixsocket</span> <span class="o">=</span> <span class="s2">&quot;ase_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">socket_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">,</span><span class="s2">&quot;ipi_&quot;</span><span class="o">+</span><span class="n">unixsocket</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;command&quot;</span> <span class="ow">in</span> <span class="n">software_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">{unixsocket}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]:</span>
                <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unixsocket</span><span class="o">=</span><span class="n">unixsocket</span><span class="p">)</span>

        <span class="n">software</span> <span class="o">=</span> <span class="n">name_to_ase_software</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">])(</span><span class="o">**</span><span class="n">software_kwargs</span><span class="p">)</span>

        <span class="n">opt_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;opt_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">opt_method</span> <span class="o">=</span> <span class="n">name_to_ase_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_method&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;opt_method&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">BFGS</span>
        <span class="n">run_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;run_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">sella</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sella&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;sella&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">time_limit_hrs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;time_limit_hrs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;time_limit_hrs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">fmaxhard</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;fmaxhard&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;fmaxhard&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">target_site_num</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;target_site_num&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;target_site_num&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">metal</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;metal&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;metal&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">facet</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;facet&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;facet&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ignore_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;ignore_errors&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xyz</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;traj&quot;</span><span class="p">:</span> <span class="c1">#take last point on trajectory</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="n">xyz</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#assume xyz</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_address</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_address</span><span class="p">)</span>

        <span class="n">sp</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">SocketIOCalculator</span><span class="p">(</span><span class="n">software</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="n">unixsocket</span><span class="o">=</span><span class="n">unixsocket</span><span class="p">)</span> <span class="k">if</span> <span class="n">socket</span> <span class="k">else</span> <span class="n">software</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;constraints&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sella</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">construct_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;freeze half slab&quot;</span><span class="p">:</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">([</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
                    <span class="p">]))</span>
                <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;freeze&quot;</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="c1">#ex: &quot;freeze all Cu&quot;</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">(</span>
                        <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">sym</span><span class="p">]</span>
                        <span class="p">))</span>

            <span class="n">opt_kwargs</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span>

            <span class="n">opt</span> <span class="o">=</span> <span class="n">opt_method</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="o">**</span><span class="n">opt_kwargs</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">time_limit_hrs</span><span class="p">):</span>
                    <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">limit_time</span><span class="p">(</span><span class="n">time_limit_hrs</span><span class="o">*</span><span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span><span class="p">):</span>
                        <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="c1"># if socket: #auto debugging example</span>
                <span class="c1">#     import logging</span>
                <span class="c1">#     logging.error(e)</span>
                <span class="c1">#     errors.append(e)</span>
                <span class="c1">#     sp.calc.close()</span>
                <span class="c1">#     fw = restart_opt_firework(self,fw_spec[&quot;_tasks&quot;])</span>
                <span class="c1">#     return FWAction(stored_data={&quot;debugged_error&quot;: errors},detours=[fw])</span>
                <span class="c1"># else:</span>
                <span class="c1">#     if not ignore_errors:</span>
                <span class="c1">#         raise e</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         errors.append(e)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">construct_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;freeze half slab&quot;</span><span class="p">:</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">([</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
                    <span class="p">]))</span>
                <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;freeze&quot;</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="c1">#ex: &quot;freeze all Cu&quot;</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">(</span>
                        <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">sym</span><span class="p">]</span>
                        <span class="p">))</span>

            <span class="n">opt</span> <span class="o">=</span> <span class="n">Sella</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">trajectory</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">time_limit_hrs</span><span class="p">):</span>
                    <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">limit_time</span><span class="p">(</span><span class="n">time_limit_hrs</span><span class="o">*</span><span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span><span class="p">):</span>
                        <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">socket</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Espresso&quot;</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#Espresso tends to error even after socket calculations finish correctly</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">converged</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">converged</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span> <span class="c1">#optimization has converged</span>
            <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fmax</span> <span class="o">=</span> <span class="n">get_fmax</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">)</span>
                <span class="n">fmaxmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">minind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">spt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;freeze half slab&quot;</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                        <span class="n">spt</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">([</span>
                                        <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">spt</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">spt</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
                                    <span class="p">]))</span>
                    <span class="n">fmaxt</span> <span class="o">=</span> <span class="n">get_fmax</span><span class="p">(</span><span class="n">spt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fmaxt</span> <span class="o">&lt;</span> <span class="n">fmaxmin</span><span class="p">:</span>
                        <span class="n">minind</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">fmaxmin</span> <span class="o">=</span> <span class="n">fmaxt</span>

                <span class="k">if</span> <span class="n">fmaxmin</span> <span class="o">&lt;</span> <span class="n">fmax</span><span class="p">:</span>
                    <span class="n">fmax</span> <span class="o">=</span> <span class="n">fmaxmin</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="n">minind</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">fmaxhard</span><span class="p">:</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Did not converge fmax below fmaxhard: </span><span class="si">{0}</span><span class="s2"> &gt; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmax</span><span class="p">,</span><span class="n">fmaxhard</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1">#In principle this was a good idea, but occupied site detection at defaults fails more often than the problem this solves occurs</span>
        <span class="c1"># if converged and target_site_num: #optimization converged to correct structure, for now just check has correct number of occupied sites</span>
        <span class="c1">#     cas = SlabAdsorptionSites(sp,facet,allow_6fold=False,composition_effect=False,</span>
        <span class="c1">#                     label_sites=True,</span>
        <span class="c1">#                     surrogate_metal=metal)</span>
        <span class="c1">#     adcov = SlabAdsorbateCoverage(sp,adsorption_sites=cas)</span>
        <span class="c1">#     sites = adcov.get_sites()</span>
        <span class="c1">#     occ = [site for site in sites if site[&quot;occupied&quot;]]</span>
        <span class="c1">#     if target_site_num != len(occ):</span>
        <span class="c1">#         converged = False</span>
        <span class="c1">#         e = StructureError</span>
        <span class="c1">#         if not ignore_errors:</span>
        <span class="c1">#             raise e</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             errors.append(e)</span>

        <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;XTB&quot;</span> <span class="ow">and</span> <span class="s2">&quot;initial_charges&quot;</span> <span class="ow">in</span> <span class="n">sp</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">sp</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s2">&quot;initial_charges&quot;</span><span class="p">]</span>
            <span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.xyz&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span><span class="s2">&quot;converged&quot;</span><span class="p">:</span> <span class="n">converged</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span><span class="s2">&quot;converged&quot;</span><span class="p">:</span> <span class="n">converged</span><span class="p">})</span></div></div>

<div class="viewcode-block" id="MolecularOptimizationFailTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularOptimizationFailTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularOptimizationFailTask</span><span class="p">(</span><span class="n">OptimizationTask</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;opt_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;opt_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularOptimizationFailTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularOptimizationFailTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">software_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;software_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">software</span> <span class="o">=</span> <span class="n">name_to_ase_software</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">])(</span><span class="o">**</span><span class="n">software_kwargs</span><span class="p">)</span>

        <span class="n">opt_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;opt_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">opt_method</span> <span class="o">=</span> <span class="n">name_to_ase_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_method&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;opt_method&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">BFGS</span>
        <span class="n">run_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;run_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

        <span class="n">sp</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">software</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">opt_method</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">trajectory</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">converged</span><span class="p">():</span>
            <span class="n">fw</span> <span class="o">=</span> <span class="n">restart_opt_firework</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;_tasks&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="p">[</span><span class="n">fw</span><span class="p">])</span>

        <span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.xyz&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="energy_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.energy_firework">[docs]</a><span class="k">def</span> <span class="nf">energy_firework</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">software</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xyz&quot;</span> <span class="p">:</span> <span class="n">xyz</span><span class="p">,</span> <span class="s2">&quot;software&quot;</span> <span class="p">:</span> <span class="n">software</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span> <span class="p">:</span> <span class="n">label</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">software_kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">software_kwargs</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_errors</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">MolecularEnergyTask</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;_energy.json&quot;</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">FileTransferTask</span><span class="p">({</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">+</span><span class="s1">&#39;_energy.json&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">out_path</span><span class="p">}],</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_errors&#39;</span><span class="p">:</span> <span class="n">ignore_errors</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">Firework</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;energy&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MolecularEnergyTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularEnergyTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularEnergyTask</span><span class="p">(</span><span class="n">EnergyTask</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;energy_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularEnergyTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularEnergyTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>
        <span class="n">software</span> <span class="o">=</span> <span class="n">name_to_ase_software</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">software_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;software_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">energy_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;energy_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;energy_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">ignore_errors</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;ignore_errors&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">software</span><span class="p">(</span><span class="o">**</span><span class="n">software_kwargs</span><span class="p">)</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">(</span><span class="o">**</span><span class="n">energy_kwargs</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;_energy.json&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">wr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">en</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span> <span class="n">exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="vibrations_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.vibrations_firework">[docs]</a><span class="k">def</span> <span class="nf">vibrations_firework</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">software</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="p">[],</span><span class="n">socket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xyz&quot;</span> <span class="p">:</span> <span class="n">xyz</span><span class="p">,</span> <span class="s2">&quot;software&quot;</span> <span class="p">:</span> <span class="n">software</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span> <span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;socket&quot;</span><span class="p">:</span> <span class="n">socket</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">software_kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">software_kwargs</span>
    <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_errors</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">MolecularVibrationsTask</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="k">elif</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">FileTransferTask</span><span class="p">({</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">+</span><span class="s1">&#39;_vib.json&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;_vib.json&#39;</span><span class="p">)},</span>
        <span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span><span class="s1">&#39;vib.0.traj&#39;</span><span class="p">,</span><span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="s2">&quot;vib.0.traj&quot;</span><span class="p">)},],</span>
        <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_errors&#39;</span><span class="p">:</span> <span class="n">ignore_errors</span><span class="p">})</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">FileTransferTask</span><span class="p">({</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span><span class="s1">&#39;vib&#39;</span><span class="p">,</span><span class="s1">&#39;dest&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="s2">&quot;vib&quot;</span><span class="p">)}],</span>
        <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;copytree&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_errors&#39;</span><span class="p">:</span> <span class="n">ignore_errors</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">Firework</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;vib&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MolecularVibrationsTask"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularVibrationsTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularVibrationsTask</span><span class="p">(</span><span class="n">VibrationTask</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">,</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">,</span><span class="s2">&quot;socket&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularVibrationsTask.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularVibrationsTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">software_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;software_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">software</span> <span class="o">=</span> <span class="n">name_to_ase_software</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">])(</span><span class="o">**</span><span class="n">software_kwargs</span><span class="p">)</span>
        <span class="n">ignore_errors</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;ignore_errors&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;socket&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;socket&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">socket</span><span class="p">:</span>
            <span class="n">unixsocket</span> <span class="o">=</span> <span class="s2">&quot;ase_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">socket_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">,</span><span class="s2">&quot;ipi_&quot;</span><span class="o">+</span><span class="n">unixsocket</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;command&quot;</span> <span class="ow">in</span> <span class="n">software_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">{unixsocket}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]:</span>
                <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unixsocket</span><span class="o">=</span><span class="n">unixsocket</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_address</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_address</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">SocketIOCalculator</span><span class="p">(</span><span class="n">software</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="n">unixsocket</span><span class="o">=</span><span class="n">unixsocket</span><span class="p">)</span> <span class="k">if</span> <span class="n">socket</span> <span class="k">else</span> <span class="n">software</span>

            <span class="n">constraints</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;constraints&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                    <span class="n">constraint</span> <span class="o">=</span> <span class="n">construct_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;freeze half slab&quot;</span><span class="p">:</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">([</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
                    <span class="p">]))</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;freeze&quot;</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="c1">#ex: &quot;freeze all Cu&quot;</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">(</span>
                        <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">sym</span><span class="p">]</span>
                        <span class="p">))</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">!=</span> <span class="n">sym</span><span class="p">]</span>

            <span class="n">vib</span> <span class="o">=</span> <span class="n">Vibrations</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">vib</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">socket</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Espresso&quot;</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c1">#Espresso tends to error even after socket calculations finish correctly</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">e</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="n">vib</span><span class="o">.</span><span class="n">write_mode</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">vibdata</span> <span class="o">=</span> <span class="n">vib</span><span class="o">.</span><span class="n">get_vibrations</span><span class="p">()</span>
            <span class="n">vibdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hessian&quot;</span><span class="p">:</span> <span class="n">vibdata</span><span class="o">.</span><span class="n">get_hessian_2d</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vibdata</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;_vib.json&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">vibdict</span><span class="p">,</span><span class="n">fout</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span> <span class="n">exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="MolecularTSEstimate"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularTSEstimate">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularTSEstimate</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rxn&quot;</span><span class="p">,</span><span class="s2">&quot;ts_path&quot;</span><span class="p">,</span><span class="s2">&quot;slab_path&quot;</span><span class="p">,</span><span class="s2">&quot;adsorbates_path&quot;</span><span class="p">,</span><span class="s2">&quot;rxns_file&quot;</span><span class="p">,</span><span class="s2">&quot;repeats&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="p">,</span><span class="s2">&quot;metal&quot;</span><span class="p">,</span><span class="s2">&quot;facet&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name_to_adjlist_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;gratom_to_molecule_atom_maps&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;gratom_to_molecule_surface_atom_maps&quot;</span><span class="p">,</span><span class="s2">&quot;opt_obj_dict&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;vib_obj_dict&quot;</span><span class="p">,</span><span class="s2">&quot;IRC_obj_dict&quot;</span><span class="p">,</span><span class="s2">&quot;nslab&quot;</span><span class="p">,</span><span class="s2">&quot;Eharmtol&quot;</span><span class="p">,</span><span class="s2">&quot;Eharmfiltertol&quot;</span><span class="p">,</span><span class="s2">&quot;Ntsmin&quot;</span><span class="p">,</span><span class="s2">&quot;max_num_hfsp_opts&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;out_path&quot;</span><span class="p">,</span><span class="s2">&quot;spawn_jobs&quot;</span><span class="p">,</span><span class="s2">&quot;nprocs&quot;</span><span class="p">,]</span>
<div class="viewcode-block" id="MolecularTSEstimate.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularTSEstimate.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">gratom_to_molecule_atom_maps</span> <span class="o">=</span> <span class="p">{</span><span class="n">sm</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sm</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;gratom_to_molecule_atom_maps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">gratom_to_molecule_surface_atom_maps</span> <span class="o">=</span> <span class="p">{</span><span class="n">sm</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sm</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;gratom_to_molecule_surface_atom_maps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;out_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;out_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">ts_path</span>
        <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;spawn_jobs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;spawn_jobs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">nprocs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;nprocs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;nprocs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="n">ts_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ts_path&quot;</span><span class="p">]</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;rxn&quot;</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="n">metal</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;metal&quot;</span><span class="p">]</span>
        <span class="n">facet</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;facet&quot;</span><span class="p">]</span>
        <span class="n">nslab</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;nslab&quot;</span><span class="p">]</span>
        <span class="n">Eharmtol</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Eharmtol&quot;</span><span class="p">]</span>
        <span class="n">Eharmfiltertol</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Eharmfiltertol&quot;</span><span class="p">]</span>
        <span class="n">Ntsmin</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Ntsmin&quot;</span><span class="p">]</span>
        <span class="n">max_num_hfsp_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;max_num_hfsp_opts&quot;</span><span class="p">]</span>
        <span class="n">slab_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;slab_path&quot;</span><span class="p">]</span>
        <span class="n">slab</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">slab_path</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;repeats&quot;</span><span class="p">]</span>

        <span class="n">cas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="n">facet</span><span class="p">,</span><span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">composition_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">label_sites</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">surrogate_metal</span><span class="o">=</span><span class="n">metal</span><span class="p">)</span>

        <span class="n">adsorbates_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;adsorbates_path&quot;</span><span class="p">]</span>


        <span class="n">reactants</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span><span class="o">.</span><span class="n">from_adjacency_list</span><span class="p">(</span><span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;reactant&quot;</span><span class="p">])</span>
        <span class="n">reactants</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">reactants</span><span class="o">.</span><span class="n">get_radical_count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span><span class="o">.</span><span class="n">from_adjacency_list</span><span class="p">(</span><span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">])</span>
        <span class="n">products</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">products</span><span class="o">.</span><span class="n">get_radical_count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">reactant_names</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;reactant_names&quot;</span><span class="p">]</span>
        <span class="n">product_names</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;product_names&quot;</span><span class="p">]</span>
        <span class="n">rxn_name</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;reaction&quot;</span><span class="p">]</span>

        <span class="n">mol_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">()</span><span class="o">.</span><span class="n">from_adjacency_list</span><span class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;multiplicity -187&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">adj</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;name_to_adjlist_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">sm</span><span class="p">,</span><span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_radical_count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">reactant_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reactant_names</span><span class="p">]</span>
        <span class="n">product_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">product_names</span><span class="p">]</span>

        <span class="n">adsorbates</span> <span class="o">=</span> <span class="n">get_unique_optimized_adsorbates</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span><span class="n">adsorbates_path</span><span class="p">,</span><span class="n">mol_dict</span><span class="p">,</span><span class="n">cas</span><span class="p">,</span><span class="n">gratom_to_molecule_surface_atom_maps</span><span class="p">,</span><span class="n">nslab</span><span class="p">)</span>

        <span class="n">forward</span><span class="p">,</span><span class="n">species_names</span> <span class="o">=</span> <span class="n">determine_TS_construction</span><span class="p">(</span><span class="n">reactant_names</span><span class="p">,</span>
                    <span class="n">reactant_mols</span><span class="p">,</span><span class="n">product_names</span><span class="p">,</span><span class="n">product_mols</span><span class="p">)</span>

        <span class="n">ordered_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">adsorbates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">species_names</span><span class="p">]</span>

        <span class="n">rnum_surf_sites</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">get_surface_sites</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reactant_mols</span><span class="p">)]</span>
        <span class="n">pnum_surf_sites</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">get_surface_sites</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">product_mols</span><span class="p">)]</span>

        <span class="n">ts_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="n">forward</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">rxn_name</span><span class="p">,</span> <span class="s2">&quot;reactants&quot;</span><span class="p">:</span> <span class="n">reactants</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">(),</span> <span class="s2">&quot;products&quot;</span><span class="p">:</span> <span class="n">products</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">(),</span>
            <span class="s2">&quot;species_names&quot;</span><span class="p">:</span> <span class="n">species_names</span><span class="p">,</span> <span class="s2">&quot;nslab&quot;</span><span class="p">:</span> <span class="n">nslab</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
            <span class="n">num_surf_sites</span> <span class="o">=</span> <span class="n">rnum_surf_sites</span>
            <span class="n">reverse_names</span> <span class="o">=</span> <span class="n">product_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">products</span>
            <span class="n">products</span> <span class="o">=</span> <span class="n">reactants</span>
            <span class="n">reactants</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="n">num_surf_sites</span> <span class="o">=</span> <span class="n">pnum_surf_sites</span>
            <span class="n">reverse_names</span> <span class="o">=</span> <span class="n">reactant_names</span>

        <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">species_names</span><span class="p">]</span>
        <span class="n">ts_dict</span><span class="p">[</span><span class="s2">&quot;mols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">()</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">]</span>
        <span class="n">ts_dict</span><span class="p">[</span><span class="s2">&quot;ads_sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ads_size</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">]</span>
        <span class="n">ts_dict</span><span class="p">[</span><span class="s2">&quot;template_mol_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_template_mol_map</span><span class="p">(</span><span class="n">reactants</span><span class="p">,</span><span class="n">mols</span><span class="p">)</span>
        <span class="n">ts_dict</span><span class="p">[</span><span class="s2">&quot;reverse_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse_names</span>
        <span class="n">ts_dict</span><span class="p">[</span><span class="s2">&quot;molecule_to_atom_maps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">value</span><span class="p">:</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">gratom_to_molecule_atom_maps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">species_names</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span><span class="s2">&quot;info.json&quot;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ts_dict</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

        <span class="n">tsstructs</span> <span class="o">=</span> <span class="n">get_unique_TS_structs</span><span class="p">(</span><span class="n">adsorbates</span><span class="p">,</span><span class="n">species_names</span><span class="p">,</span><span class="n">cas</span><span class="p">,</span><span class="n">nslab</span><span class="p">,</span><span class="n">num_surf_sites</span><span class="p">,</span><span class="n">mol_dict</span><span class="p">,</span>
                                 <span class="n">gratom_to_molecule_atom_maps</span><span class="p">,</span><span class="n">gratom_to_molecule_surface_atom_maps</span><span class="p">,</span>
                                 <span class="n">facet</span><span class="p">,</span><span class="n">metal</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of TS guesses pre-empty-sites:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tsstructs</span><span class="p">))</span>

        <span class="n">tsstructs_out</span><span class="p">,</span><span class="n">constraint_lists</span><span class="p">,</span><span class="n">atom_bond_potential_lists</span><span class="p">,</span><span class="n">site_bond_potential_lists</span><span class="p">,</span><span class="n">site_bond_dict_list</span> <span class="o">=</span> <span class="n">generate_constraints_harmonic_parameters</span><span class="p">(</span>
                                            <span class="n">tsstructs</span><span class="p">,</span><span class="n">adsorbates</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">reactants</span><span class="p">,</span>
                                             <span class="n">products</span><span class="p">,</span><span class="n">rxn</span><span class="p">[</span><span class="s2">&quot;reaction_family&quot;</span><span class="p">],</span><span class="n">template_reversed</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">forward</span><span class="p">),</span>
                                            <span class="n">ordered_names</span><span class="o">=</span><span class="n">species_names</span><span class="p">,</span><span class="n">reverse_names</span><span class="o">=</span><span class="n">reverse_names</span><span class="p">,</span>
                                            <span class="n">mol_dict</span><span class="o">=</span><span class="n">mol_dict</span><span class="p">,</span><span class="n">gratom_to_molecule_atom_maps</span><span class="o">=</span><span class="n">gratom_to_molecule_atom_maps</span><span class="p">,</span>
                                            <span class="n">gratom_to_molecule_surface_atom_maps</span><span class="o">=</span><span class="n">gratom_to_molecule_surface_atom_maps</span><span class="p">,</span>
                                            <span class="n">nslab</span><span class="o">=</span><span class="n">nslab</span><span class="p">,</span><span class="n">facet</span><span class="o">=</span><span class="n">facet</span><span class="p">,</span><span class="n">metal</span><span class="o">=</span><span class="n">metal</span><span class="p">,</span><span class="n">cas</span><span class="o">=</span><span class="n">cas</span><span class="p">)</span>


        <span class="n">out_tsstructs</span><span class="p">,</span><span class="n">new_atom_bond_potential_lists</span><span class="p">,</span><span class="n">new_site_bond_potential_lists</span><span class="p">,</span><span class="n">new_constraint_lists</span> <span class="o">=</span> <span class="n">get_surface_forming_bond_pairings</span><span class="p">(</span>
                            <span class="n">tsstructs_out</span><span class="p">,</span><span class="n">atom_bond_potential_lists</span><span class="p">,</span><span class="n">site_bond_potential_lists</span><span class="p">,</span><span class="n">constraint_lists</span><span class="p">,</span><span class="n">site_bond_dict_list</span><span class="p">,</span><span class="n">cas</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of TS guesses with empty sites:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_tsstructs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">max_num_hfsp_opts</span><span class="p">:</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">index_site_bond_potential_lists_by_site_distances</span><span class="p">(</span><span class="n">new_site_bond_potential_lists</span><span class="p">)[:</span><span class="n">max_num_hfsp_opts</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">out_tsstructs</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_tsstructs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
            <span class="n">new_atom_bond_potential_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_atom_bond_potential_lists</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
            <span class="n">new_site_bond_potential_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_site_bond_potential_lists</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
            <span class="n">new_constraint_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_constraint_lists</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of TS guesses after filtering by max distance between sites&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_tsstructs</span><span class="p">))</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">out_tsstructs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">new_atom_bond_potential_lists</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">new_site_bond_potential_lists</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">nslab</span><span class="p">,</span><span class="n">new_constraint_lists</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">ts_path</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_tsstructs</span><span class="p">))]</span>

        <span class="c1">#with mp.Pool(nprocs) as pool:</span>
        <span class="c1">#    outputs = pool.map(map_harmonically_forced_xtb,inputs)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">map_harmonically_forced_xtb</span><span class="p">,</span><span class="n">inputs</span><span class="p">))</span>

        <span class="n">xyzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">Es</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">xyzs</span><span class="p">,</span><span class="n">Es</span> <span class="o">=</span> <span class="n">filter_nonunique_TS_guess_indices</span><span class="p">(</span><span class="n">xyzs</span><span class="p">,</span><span class="n">Es</span><span class="p">)</span> <span class="c1">#remove identical guesses (that will just get filtered out later in the collect resulting in less guesses)</span>

        <span class="n">Einds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Es</span><span class="p">))</span>
        <span class="n">Emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Es</span><span class="p">))</span>
        <span class="n">xyzsout</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">Eind</span> <span class="ow">in</span> <span class="n">Einds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Es</span><span class="p">[</span><span class="n">Eind</span><span class="p">]</span><span class="o">/</span><span class="n">Emin</span> <span class="o">&lt;</span> <span class="n">Eharmtol</span><span class="p">:</span> <span class="c1">#include all TSs with energy close to Emin</span>
                <span class="n">xyzsout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyzs</span><span class="p">[</span><span class="n">Eind</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">Es</span><span class="p">[</span><span class="n">Eind</span><span class="p">]</span><span class="o">/</span><span class="n">Emin</span> <span class="o">&gt;</span> <span class="n">Eharmfiltertol</span><span class="p">:</span> <span class="c1">#if the energy is much larger than Emin skip it</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyzsout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Ntsmin</span><span class="p">:</span> <span class="c1">#if the energy isn&#39;t similar, but isn&#39;t much larger include the smallest until Ntsmin is reached</span>
                <span class="n">xyzsout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyzs</span><span class="p">[</span><span class="n">Eind</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">spawn_jobs</span><span class="p">:</span>
            <span class="n">irc_obj_dict_forward</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;IRC_obj_dict&quot;</span><span class="p">])</span>
            <span class="n">irc_obj_dict_forward</span><span class="p">[</span><span class="s2">&quot;forward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">irc_obj_dict_reverse</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;IRC_obj_dict&quot;</span><span class="p">])</span>
            <span class="n">irc_obj_dict_reverse</span><span class="p">[</span><span class="s2">&quot;forward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">ctask</span> <span class="o">=</span> <span class="n">MolecularCollect</span><span class="p">({</span><span class="s2">&quot;xyzs&quot;</span><span class="p">:</span><span class="n">xyzsout</span><span class="p">,</span><span class="s2">&quot;check_symm&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;fw_generators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;optimize_firework&quot;</span><span class="p">,[</span><span class="s2">&quot;vibrations_firework&quot;</span><span class="p">,</span><span class="s2">&quot;IRC_firework&quot;</span><span class="p">,</span><span class="s2">&quot;IRC_firework&quot;</span><span class="p">]],</span>
                <span class="s2">&quot;fw_generator_dicts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_obj_dict&quot;</span><span class="p">],[</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;vib_obj_dict&quot;</span><span class="p">],</span><span class="n">irc_obj_dict_forward</span><span class="p">,</span><span class="n">irc_obj_dict_reverse</span><span class="p">]],</span>
                    <span class="s2">&quot;out_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;opt.xyz&quot;</span><span class="p">,[</span><span class="s2">&quot;vib.json&quot;</span><span class="p">,</span><span class="s2">&quot;irc_forward.traj&quot;</span><span class="p">,</span><span class="s2">&quot;irc_reverse.traj&quot;</span><span class="p">]],</span><span class="s2">&quot;future_check_symms&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">],</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;TS&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">rxn_name</span><span class="p">})</span>
            <span class="n">cfw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">ctask</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;TS&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">rxn_name</span><span class="o">+</span><span class="s2">&quot;_collect&quot;</span><span class="p">,</span><span class="n">spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_priority&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
            <span class="n">newwf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span><span class="n">cfw</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rxn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rxn_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">newwf</span><span class="p">)</span> <span class="c1">#using detour allows us to inherit children from the original collect to the subsequent collects</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="collect_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.collect_firework">[docs]</a><span class="k">def</span> <span class="nf">collect_firework</span><span class="p">(</span><span class="n">xyzs</span><span class="p">,</span><span class="n">check_symm</span><span class="p">,</span><span class="n">fw_generators</span><span class="p">,</span><span class="n">fw_generator_dicts</span><span class="p">,</span><span class="n">out_names</span><span class="p">,</span><span class="n">future_check_symms</span><span class="p">,</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">MolecularCollect</span><span class="p">({</span><span class="s2">&quot;xyzs&quot;</span><span class="p">:</span> <span class="n">xyzs</span><span class="p">,</span> <span class="s2">&quot;check_symm&quot;</span><span class="p">:</span> <span class="n">check_symm</span><span class="p">,</span> <span class="s2">&quot;fw_generators&quot;</span><span class="p">:</span> <span class="n">fw_generators</span><span class="p">,</span>
        <span class="s2">&quot;fw_generator_dicts&quot;</span><span class="p">:</span> <span class="n">fw_generator_dicts</span><span class="p">,</span> <span class="s2">&quot;out_names&quot;</span><span class="p">:</span> <span class="n">out_names</span><span class="p">,</span> <span class="s2">&quot;future_check_symms&quot;</span><span class="p">:</span> <span class="n">future_check_symms</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">Firework</span><span class="p">([</span><span class="n">task</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;collect&quot;</span><span class="p">,</span><span class="n">spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_priority&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span></div>

<div class="viewcode-block" id="MolecularCollect"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularCollect">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularCollect</span><span class="p">(</span><span class="n">CollectTask</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xyzs&quot;</span><span class="p">,</span><span class="s2">&quot;check_symm&quot;</span><span class="p">,</span><span class="s2">&quot;fw_generators&quot;</span><span class="p">,</span><span class="s2">&quot;fw_generator_dicts&quot;</span><span class="p">,</span><span class="s2">&quot;out_names&quot;</span><span class="p">,</span><span class="s2">&quot;future_check_symms&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularCollect.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularCollect.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">xyzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xyzs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xyz</span><span class="p">)]</span> <span class="c1">#if the associated task errored a file may not be present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;check_symm&quot;</span><span class="p">]:</span>
            <span class="n">xyzs</span> <span class="o">=</span> <span class="n">get_unique_sym</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)</span> <span class="c1">#only unique structures</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No xyzs to collect&quot;</span><span class="p">)</span>

        <span class="n">fw_generators</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;fw_generators&quot;</span><span class="p">]</span>
        <span class="n">fw_generator_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;fw_generator_dicts&quot;</span><span class="p">]</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;out_names&quot;</span><span class="p">]</span>
        <span class="n">future_check_symms</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;future_check_symms&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fw_generators</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fw_generators</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">fw_generators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fw_generators</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fw_generator_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">fw_generator_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fw_generator_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">out_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>


        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_xyzs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fw_generator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fw_generators</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fw_generator</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">fw_generator</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fw_generator_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;out_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xyz</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">out_names</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_names</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">out_xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;out_path&quot;</span><span class="p">])</span>
                <span class="n">fw</span> <span class="o">=</span> <span class="n">fw_generator</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">fw</span> <span class="o">=</span> <span class="p">[</span><span class="n">fw</span><span class="p">]</span>
                <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fw_generators</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">MolecularCollect</span><span class="p">({</span><span class="s2">&quot;xyzs&quot;</span><span class="p">:</span> <span class="n">out_xyzs</span><span class="p">,</span><span class="s2">&quot;check_symm&quot;</span><span class="p">:</span> <span class="n">future_check_symms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;fw_generators&quot;</span><span class="p">:</span> <span class="n">fw_generators</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s2">&quot;fw_generator_dicts&quot;</span><span class="p">:</span> <span class="n">fw_generator_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                    <span class="s2">&quot;out_names&quot;</span><span class="p">:</span> <span class="n">out_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s2">&quot;future_check_symms&quot;</span><span class="p">:</span> <span class="n">future_check_symms</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]})</span>
            <span class="n">cfw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">task</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="n">fws</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;collect&quot;</span><span class="p">)</span>
            <span class="n">newwf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fws</span><span class="o">+</span><span class="p">[</span><span class="n">cfw</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;collect&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;fw_generators&quot;</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">newwf</span><span class="p">)</span> <span class="c1">#using detour allows us to inherit children from the original collect to the subsequent collects</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">fws</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TSnudge_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.TSnudge_firework">[docs]</a><span class="k">def</span> <span class="nf">TSnudge_firework</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">forward_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">reverse_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spawn_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">software</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">opt_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sella</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">socket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">run_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">constraints</span><span class="o">=</span><span class="p">[],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xyz is really the vibrational output data file</span>
<span class="sd">        out_path is a dud variable here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">MolecularTSNudge</span><span class="p">(</span><span class="n">vib_traj</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">forward_path</span><span class="o">=</span><span class="n">forward_path</span><span class="p">,</span><span class="n">reverse_path</span><span class="o">=</span><span class="n">reverse_path</span><span class="p">,</span><span class="n">spawn_jobs</span><span class="o">=</span><span class="n">spawn_jobs</span><span class="p">,</span><span class="n">software</span><span class="o">=</span><span class="n">software</span><span class="p">,</span>
            <span class="n">opt_method</span><span class="o">=</span><span class="n">opt_method</span><span class="p">,</span><span class="n">sella</span><span class="o">=</span><span class="n">sella</span><span class="p">,</span><span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="n">software_kwargs</span><span class="p">,</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="n">opt_kwargs</span><span class="p">,</span><span class="n">run_kwargs</span><span class="o">=</span><span class="n">run_kwargs</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span><span class="n">ignore_errors</span><span class="o">=</span><span class="n">ignore_errors</span><span class="p">)</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">task</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;TSnudge&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fw</span></div>

<div class="viewcode-block" id="MolecularTSNudge"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularTSNudge">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularTSNudge</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vib_traj&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;forward_path&quot;</span><span class="p">,</span><span class="s2">&quot;reverse_path&quot;</span><span class="p">,</span><span class="s2">&quot;spawn_jobs&quot;</span><span class="p">,</span><span class="s2">&quot;software&quot;</span><span class="p">,</span><span class="s2">&quot;opt_method&quot;</span><span class="p">,</span><span class="s2">&quot;sella&quot;</span><span class="p">,</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span>
            <span class="s2">&quot;software_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;opt_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;run_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularTSNudge.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularTSNudge.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">forward_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;forward_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;forward_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;forward_path&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;vib_traj&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_forward&quot;</span><span class="p">)</span>
        <span class="n">reverse_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;reverse_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;reverse_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;reverse_path&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;vib_traj&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_reverse&quot;</span><span class="p">)</span>
        <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;spawn_jobs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;spawn_jobs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">ignore_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;ignore_errors&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">AfterTS</span><span class="o">.</span><span class="n">get_forward_and_reverse</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;vib_traj&quot;</span><span class="p">],</span>
            <span class="n">forward_path</span><span class="p">,</span>
            <span class="n">reverse_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">spawn_jobs</span><span class="p">:</span>
            <span class="n">fwf</span> <span class="o">=</span> <span class="n">optimize_firework</span><span class="p">(</span><span class="n">forward_path</span><span class="o">+</span><span class="s2">&quot;.xyz&quot;</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span><span class="n">opt_method</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_method&quot;</span><span class="p">],</span><span class="n">sella</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sella&quot;</span><span class="p">],</span>
                <span class="n">socket</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;socket&quot;</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">],</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_kwargs&quot;</span><span class="p">],</span>
                                  <span class="n">run_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">],</span><span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span>
                                  <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">forward_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_forward_optimized.xyz&quot;</span><span class="p">),</span>
                                  <span class="n">ignore_errors</span><span class="o">=</span><span class="n">ignore_errors</span><span class="p">)</span>
            <span class="n">fwr</span> <span class="o">=</span> <span class="n">optimize_firework</span><span class="p">(</span><span class="n">reverse_path</span><span class="o">+</span><span class="s2">&quot;.xyz&quot;</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span><span class="n">opt_method</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_method&quot;</span><span class="p">],</span><span class="n">sella</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sella&quot;</span><span class="p">],</span>
                <span class="n">socket</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;socket&quot;</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">],</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_kwargs&quot;</span><span class="p">],</span>
                                  <span class="n">run_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">],</span><span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span>
                                  <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">reverse_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_reverse_optimized.xyz&quot;</span><span class="p">),</span>
                                  <span class="n">ignore_errors</span><span class="o">=</span><span class="n">ignore_errors</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">additions</span><span class="o">=</span><span class="p">[</span><span class="n">fwf</span><span class="p">,</span><span class="n">fwr</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="IRC_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.IRC_firework">[docs]</a><span class="k">def</span> <span class="nf">IRC_firework</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spawn_jobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">software</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">socket</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">run_kwargs</span><span class="o">=</span><span class="p">{},</span><span class="n">constraints</span><span class="o">=</span><span class="p">[],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;_irc.traj&quot;</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">MolecularIRC</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">software</span><span class="o">=</span><span class="n">software</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">,</span><span class="n">software_kwargs</span><span class="o">=</span><span class="n">software_kwargs</span><span class="p">,</span><span class="n">opt_kwargs</span><span class="o">=</span><span class="n">opt_kwargs</span><span class="p">,</span><span class="n">run_kwargs</span><span class="o">=</span><span class="n">run_kwargs</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span><span class="n">ignore_errors</span><span class="o">=</span><span class="n">ignore_errors</span><span class="p">,</span><span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">FileTransferTask</span><span class="p">({</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">+</span><span class="s1">&#39;_irc.traj&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">out_path</span><span class="p">}],</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_errors&#39;</span> <span class="p">:</span> <span class="n">ignore_errors</span><span class="p">})</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;_IRC&quot;</span><span class="p">,</span><span class="n">spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_priority&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">fw</span></div>

<div class="viewcode-block" id="MolecularIRC"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularIRC">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularIRC</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">,</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span>
            <span class="s2">&quot;software_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;opt_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;run_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore_errors&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="MolecularIRC.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularIRC.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">software_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;software_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;socket&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;socket&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">socket</span><span class="p">:</span>
            <span class="n">unixsocket</span> <span class="o">=</span> <span class="s2">&quot;ase_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">socket_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">,</span><span class="s2">&quot;ipi_&quot;</span><span class="o">+</span><span class="n">unixsocket</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;command&quot;</span> <span class="ow">in</span> <span class="n">software_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">{unixsocket}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]:</span>
                <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">software_kwargs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unixsocket</span><span class="o">=</span><span class="n">unixsocket</span><span class="p">)</span>

        <span class="n">software</span> <span class="o">=</span> <span class="n">name_to_ase_software</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">])(</span><span class="o">**</span><span class="n">software_kwargs</span><span class="p">)</span>

        <span class="n">opt_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;opt_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;opt_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">run_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;run_kwargs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;run_kwargs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">ignore_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;ignore_errors&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;forward&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;forward&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xyz</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;traj&quot;</span><span class="p">:</span> <span class="c1">#take last point on trajectory</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="n">xyz</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#assume xyz</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_address</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_address</span><span class="p">)</span>

        <span class="n">sp</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">SocketIOCalculator</span><span class="p">(</span><span class="n">software</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="n">unixsocket</span><span class="o">=</span><span class="n">unixsocket</span><span class="p">)</span> <span class="k">if</span> <span class="n">socket</span> <span class="k">else</span> <span class="n">software</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;constraints&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;freeze half slab&quot;</span><span class="p">:</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">([</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="p">]))</span>
            <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;freeze&quot;</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="c1">#ex: &quot;freeze all Cu&quot;</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">FixAtoms</span><span class="p">(</span>
                    <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sp</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">sym</span><span class="p">]</span>
                    <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not interpret constraint: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="n">IRC</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">trajectory</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;_irc.traj&quot;</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">eta</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
                <span class="n">run_kwargs</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;forward&quot;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_kwargs</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;reverse&quot;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">socket</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;software&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Espresso&quot;</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#Espresso tends to error even after socket calculations finish correctly</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">converged</span><span class="p">():</span>
            <span class="n">e</span> <span class="o">=</span> <span class="ne">ValueError</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="map_harmonically_forced_xtb"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.map_harmonically_forced_xtb">[docs]</a><span class="k">def</span> <span class="nf">map_harmonically_forced_xtb</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">tsstruct</span><span class="p">,</span><span class="n">atom_bond_potentials</span><span class="p">,</span><span class="n">site_bond_potentials</span><span class="p">,</span><span class="n">nslab</span><span class="p">,</span><span class="n">constraints</span><span class="p">,</span><span class="n">ts_path</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="nb">input</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span>
    <span class="n">sp</span><span class="p">,</span><span class="n">Eharm</span><span class="p">,</span><span class="n">Fharm</span> <span class="o">=</span> <span class="n">run_harmonically_forced_xtb</span><span class="p">(</span><span class="n">tsstruct</span><span class="p">,</span><span class="n">atom_bond_potentials</span><span class="p">,</span><span class="n">site_bond_potentials</span><span class="p">,</span><span class="n">nslab</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;GFN1-xTB&quot;</span><span class="p">,</span>
                                   <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sp</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;initial_charges&quot;</span> <span class="ow">in</span> <span class="n">sp</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1">#avoid bug in ase</span>
            <span class="k">del</span> <span class="n">sp</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s2">&quot;initial_charges&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="s2">&quot;harm.json&quot;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;harmonic energy&quot;</span><span class="p">:</span> <span class="n">Eharm</span><span class="p">,</span> <span class="s2">&quot;harmonic force&quot;</span><span class="p">:</span> <span class="n">Fharm</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
        <span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="s2">&quot;xtb.xyz&quot;</span><span class="p">),</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="s2">&quot;xtb.xyz&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">Eharm</span><span class="p">,</span><span class="n">xyz</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_parallel_gfn1xtb_opt"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.run_parallel_gfn1xtb_opt">[docs]</a><span class="k">def</span> <span class="nf">run_parallel_gfn1xtb_opt</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="n">nprocs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocs</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">run_gfn1xtb_opt</span><span class="p">,</span><span class="n">inputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="run_gfn1xtb_opt"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.run_gfn1xtb_opt">[docs]</a><span class="k">def</span> <span class="nf">run_gfn1xtb_opt</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
    <span class="n">xyz</span><span class="p">,</span><span class="n">xyzout</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">slab_path</span><span class="p">,</span><span class="n">bonds</span><span class="p">,</span><span class="n">av_dists_tuple</span><span class="p">,</span><span class="n">repeats</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="n">adsorbed</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">slab</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">slab_path</span><span class="p">)</span>
    <span class="n">big_slab</span> <span class="o">=</span> <span class="n">slab</span> <span class="o">*</span> <span class="n">repeats</span>
    <span class="n">nbig_slab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">big_slab</span><span class="p">)</span>
    <span class="n">ts_estimate</span> <span class="o">=</span> <span class="n">adsorbed</span><span class="p">[</span><span class="n">nbig_slab</span><span class="p">:]</span>
    <span class="n">traj_path</span> <span class="o">=</span> <span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span>
    <span class="n">adsplacer</span> <span class="o">=</span> <span class="n">AdsorbatePlacer</span><span class="p">(</span>
        <span class="n">big_slab</span><span class="p">,</span> <span class="n">ts_estimate</span><span class="p">,</span> <span class="n">bonds</span><span class="p">,</span> <span class="n">av_dists_tuple</span><span class="p">,</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="n">traj_path</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">adsplacer</span><span class="o">.</span><span class="n">ads_ref</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">XTB</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;GFN1-xTB&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">adsplacer</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">write</span><span class="p">(</span><span class="n">xyzout</span><span class="p">,</span><span class="n">read</span><span class="p">(</span><span class="n">traj_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="TSxTBOpt_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.TSxTBOpt_firework">[docs]</a><span class="k">def</span> <span class="nf">TSxTBOpt_firework</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">slab_path</span><span class="p">,</span><span class="n">bonds</span><span class="p">,</span><span class="n">repeats</span><span class="p">,</span><span class="n">av_dists_tuple</span><span class="p">,</span><span class="n">out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">parents</span><span class="o">=</span><span class="p">[],</span><span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xyz&quot;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span> <span class="s2">&quot;slab_path&quot;</span><span class="p">:</span> <span class="n">slab_path</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="n">bonds</span><span class="p">,</span> <span class="s2">&quot;repeats&quot;</span><span class="p">:</span> <span class="n">repeats</span><span class="p">,</span> <span class="s2">&quot;av_dists_tuple&quot;</span><span class="p">:</span> <span class="n">av_dists_tuple</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;ignore_errors&quot;</span><span class="p">:</span> <span class="n">ignore_errors</span><span class="p">}</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">MolecularTSxTBOpt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">FileTransferTask</span><span class="p">({</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">+</span><span class="s1">&#39;.traj&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">out_path</span><span class="p">}],</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s2">&quot;ignore_errors&quot;</span><span class="p">:</span> <span class="n">ignore_errors</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">Firework</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span><span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;TSxTBopt&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MolecularTSxTBOpt"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularTSxTBOpt">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MolecularTSxTBOpt</span><span class="p">(</span><span class="n">OptimizationTask</span><span class="p">):</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span><span class="s2">&quot;slab_path&quot;</span><span class="p">,</span><span class="s2">&quot;bonds&quot;</span><span class="p">,</span><span class="s2">&quot;repeats&quot;</span><span class="p">,</span><span class="s2">&quot;av_dists_tuple&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="MolecularTSxTBOpt.run_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.MolecularTSxTBOpt.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;label&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;xtb&quot;</span>
        <span class="n">ignore_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;ignore_errors&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">adsorbed</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">])</span>
            <span class="n">slab</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;slab_path&quot;</span><span class="p">])</span>
            <span class="n">big_slab</span> <span class="o">=</span> <span class="n">slab</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;repeats&quot;</span><span class="p">]</span>
            <span class="n">nbig_slab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">big_slab</span><span class="p">)</span>
            <span class="n">ts_estimate</span> <span class="o">=</span> <span class="n">adsorbed</span><span class="p">[</span><span class="n">nbig_slab</span><span class="p">:]</span>

            <span class="n">adsplacer</span> <span class="o">=</span> <span class="n">AdsorbatePlacer</span><span class="p">(</span>
                <span class="n">big_slab</span><span class="p">,</span> <span class="n">ts_estimate</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;av_dists_tuple&quot;</span><span class="p">],</span>
                <span class="n">trajectory</span><span class="o">=</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span>
            <span class="p">)</span>

            <span class="n">adsplacer</span><span class="o">.</span><span class="n">ads_ref</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">XTB</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;GFN1-xTB&quot;</span><span class="p">))</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">adsplacer</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span> <span class="n">exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="StructureError"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.StructureError">[docs]</a><span class="k">class</span> <span class="nc">StructureError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="TimeLimitError"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.TimeLimitError">[docs]</a><span class="k">class</span> <span class="nc">TimeLimitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>

<div class="viewcode-block" id="limit_time"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.limit_time">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">limit_time</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="c1">#seconds</span>
    <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">TimeLimitError</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="index_site_bond_potential_lists_by_site_distances"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.index_site_bond_potential_lists_by_site_distances">[docs]</a><span class="k">def</span> <span class="nf">index_site_bond_potential_lists_by_site_distances</span><span class="p">(</span><span class="n">site_bond_potential_lists</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_bond_potential_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#if only one site can&#39;t do this analysis</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">site_bond_potential_lists</span><span class="p">))))</span>

    <span class="n">max_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_max_site_dist</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">site_bond_potential_lists</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">max_dists</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_max_site_dist"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.get_max_site_dist">[docs]</a><span class="k">def</span> <span class="nf">get_max_site_dist</span><span class="p">(</span><span class="n">site_bond_potential</span><span class="p">):</span>
    <span class="n">vecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;site_pos&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">site_bond_potential</span><span class="p">]</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vecs</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">max_dist</span><span class="p">:</span>
                    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">max_dist</span></div>

<div class="viewcode-block" id="get_task_index"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.get_task_index">[docs]</a><span class="k">def</span> <span class="nf">get_task_index</span><span class="p">(</span><span class="n">task_dict</span><span class="p">,</span><span class="n">task_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get the index of a task in the task list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_fw_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_dict</span><span class="p">[</span><span class="s1">&#39;_fw_name&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span></div>

<div class="viewcode-block" id="restart_opt_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.restart_opt_firework">[docs]</a><span class="k">def</span> <span class="nf">restart_opt_firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="n">task_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    generate a firework to restart an optimization firework from the trajectory</span>
<span class="sd">    file based on the optimization task and the full task list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">traj_file</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">traj_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span><span class="n">traj_file</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span><span class="n">traj_file</span><span class="p">)</span>
    <span class="n">new_task</span> <span class="o">=</span> <span class="n">reconstruct_task</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">orig_task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reconstruct_firework</span><span class="p">(</span><span class="n">new_task</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">task_list</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="reconstruct_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.reconstruct_task">[docs]</a><span class="k">def</span> <span class="nf">reconstruct_task</span><span class="p">(</span><span class="n">task_dict</span><span class="p">,</span><span class="n">orig_task</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    regenerate a task based on the task_dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">task_dict</span><span class="p">[</span><span class="s2">&quot;_fw_name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">orig_task</span><span class="p">:</span>
        <span class="n">fcn</span> <span class="o">=</span> <span class="n">orig_task</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fcn</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">task_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fcn</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="reconstruct_firework"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.reconstruct_firework">[docs]</a><span class="k">def</span> <span class="nf">reconstruct_firework</span><span class="p">(</span><span class="n">new_task</span><span class="p">,</span><span class="n">old_task</span><span class="p">,</span><span class="n">task_list</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reconstruct a firework replacing an old_task with new_task based on the task list</span>
<span class="sd">    full indicates whether all of the tasks should be included or just those starting</span>
<span class="sd">    from the replaced task</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_index</span> <span class="o">=</span> <span class="n">get_task_index</span><span class="p">(</span><span class="n">old_task</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span><span class="n">task_list</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">task_index</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_task</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">full</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">task_index</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruct_task</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Firework</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="construct_constraint"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.construct_constraint">[docs]</a><span class="k">def</span> <span class="nf">construct_constraint</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    construct a constrain from a dictionary that is the input to the constraint</span>
<span class="sd">    constructor plus an additional &quot;type&quot; key that indices the name of the constraint</span>
<span class="sd">    returns the constraint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constraint_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">constructor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="s2">&quot;ase.constraints&quot;</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
    <span class="k">del</span> <span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">constructor</span><span class="p">(</span><span class="o">**</span><span class="n">constraint_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_fizzled_fws"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.get_fizzled_fws">[docs]</a><span class="k">def</span> <span class="nf">get_fizzled_fws</span><span class="p">(</span><span class="n">lpad</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_ids_in_wfs</span><span class="p">()</span> <span class="k">if</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;FIZZLED&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="get_completed_fws"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.get_completed_fws">[docs]</a><span class="k">def</span> <span class="nf">get_completed_fws</span><span class="p">(</span><span class="n">lpad</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_ids_in_wfs</span><span class="p">()</span> <span class="k">if</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;COMPLETED&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="get_fw_traceback_task"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.get_fw_traceback_task">[docs]</a><span class="k">def</span> <span class="nf">get_fw_traceback_task</span><span class="p">(</span><span class="n">fizzfw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get the traceback and task errored on for the fizzled firework</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">fizzfw</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;launches&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;action&quot;</span><span class="p">][</span><span class="s2">&quot;stored_data&quot;</span><span class="p">][</span><span class="s2">&quot;_exception&quot;</span><span class="p">][</span><span class="s2">&quot;_stacktrace&quot;</span><span class="p">]</span>
    <span class="n">task_dict</span> <span class="o">=</span> <span class="n">fizzfw</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;launches&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;action&quot;</span><span class="p">][</span><span class="s2">&quot;stored_data&quot;</span><span class="p">][</span><span class="s2">&quot;_task&quot;</span><span class="p">]</span>
    <span class="n">task_list</span> <span class="o">=</span> <span class="n">fizzfw</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;_tasks&quot;</span><span class="p">]</span>
    <span class="n">task_index</span> <span class="o">=</span> <span class="n">get_task_index</span><span class="p">(</span><span class="n">task_dict</span><span class="p">,</span><span class="n">task_list</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">fizzfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">trace</span><span class="p">,</span><span class="n">task</span></div>

<div class="viewcode-block" id="debug_fizzled"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.debug_fizzled">[docs]</a><span class="k">def</span> <span class="nf">debug_fizzled</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    generate a new firework to replace the fizzled firework</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">launch_dir</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s2">&quot;launches&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;launch_dir&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">),</span><span class="n">OptimizationTask</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;ValueError&quot;</span> <span class="ow">in</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">launch_dir</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">),</span><span class="n">path</span><span class="p">)</span>
            <span class="n">task_dict</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">task_dict</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.traj&quot;</span><span class="p">)</span>
            <span class="n">new_task</span> <span class="o">=</span> <span class="n">reconstruct_task</span><span class="p">(</span><span class="n">task_dict</span><span class="p">,</span><span class="n">orig_task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">reconstruct_firework</span><span class="p">(</span><span class="n">new_task</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">fw</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;_tasks&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span></div>

<div class="viewcode-block" id="restart_wf"><a class="viewcode-back" href="../../source/pynta.html#pynta.tasks.restart_wf">[docs]</a><span class="k">def</span> <span class="nf">restart_wf</span><span class="p">(</span><span class="n">lpad</span><span class="p">,</span><span class="n">queue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    lpad is a LaunchPad object</span>
<span class="sd">    queue is a boolean indicating if running in a queue or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">fworker</span> <span class="o">=</span> <span class="n">FWorker</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">fireworks</span><span class="o">.</span><span class="n">fw_config</span><span class="o">.</span><span class="n">FWORKER_LOC</span><span class="p">)</span>
        <span class="n">qadapter</span> <span class="o">=</span> <span class="n">load_object_from_file</span><span class="p">(</span><span class="n">fireworks</span><span class="o">.</span><span class="n">fw_config</span><span class="o">.</span><span class="n">QUEUEADAPTER_LOC</span><span class="p">)</span>

    <span class="n">fw_ids</span> <span class="o">=</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_ids</span><span class="p">()</span>

    <span class="n">wf</span> <span class="o">=</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_wf_by_fw_id</span><span class="p">(</span><span class="n">fw_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#assumes only one workflow...should fix</span>

    <span class="n">fizzmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">fws</span> <span class="o">=</span> <span class="p">[</span><span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fw_ids</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">fws</span><span class="p">:</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fws</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fw2</span> <span class="ow">in</span> <span class="n">fws</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fw2</span><span class="o">.</span><span class="n">fw_id</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">]:</span>
                <span class="n">fw2</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

    <span class="n">completed_fws</span> <span class="o">=</span> <span class="p">[</span><span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">idnum</span><span class="p">)</span> <span class="k">for</span> <span class="n">idnum</span> <span class="ow">in</span> <span class="n">fw_ids</span> <span class="k">if</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">idnum</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;COMPLETED&quot;</span><span class="p">]</span>
    <span class="n">complete_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">idnum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fw_ids</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">idnum</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;COMPLETED&quot;</span><span class="p">]</span>

    <span class="n">fizzfws</span> <span class="o">=</span> <span class="p">[</span><span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">idnum</span><span class="p">)</span> <span class="k">for</span> <span class="n">idnum</span> <span class="ow">in</span> <span class="n">fw_ids</span> <span class="k">if</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">idnum</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;FIZZLED&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">fizzfw</span> <span class="ow">in</span> <span class="n">fizzfws</span><span class="p">:</span>
        <span class="n">fw_id</span> <span class="o">=</span> <span class="n">fizzfw</span><span class="o">.</span><span class="n">fw_id</span>
        <span class="n">trace</span><span class="p">,</span><span class="n">task</span> <span class="o">=</span> <span class="n">get_fw_traceback_task</span><span class="p">(</span><span class="n">fizzfw</span><span class="p">)</span>
        <span class="n">new_fw</span> <span class="o">=</span> <span class="n">debug_fizzled</span><span class="p">(</span><span class="n">fizzfw</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="n">task</span><span class="p">)</span>
        <span class="n">fizzmap</span><span class="p">[</span><span class="n">fw_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">fw_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_fw</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fizzmap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">fw_old</span> <span class="o">=</span> <span class="n">fws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fw_new</span> <span class="o">=</span> <span class="n">fizzmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">fws</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fw_old</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fw_old</span><span class="p">)</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw_new</span><span class="p">)</span>
        <span class="n">fws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_new</span>

    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">complete_inds</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">fws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

    <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span>
    <span class="n">lpad</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">require_password</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lpad</span><span class="o">.</span><span class="n">add_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">rapidfirequeue</span><span class="p">(</span><span class="n">lpad</span><span class="p">,</span><span class="n">fworker</span><span class="p">,</span><span class="n">qadapter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rapidfire</span><span class="p">(</span><span class="n">lpad</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Copyright 2021 National Technology &amp; Engineering Solutions of Sandia, LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software.
      <span class="lastupdated">
        Last updated on Wed, 25 Jan 2023 16:24:48.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>